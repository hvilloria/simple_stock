- content_for :page_title, "Facturas de Proveedores"

.container.mx-auto.px-6.py-6

  -# Header con navegaci√≥n
  .flex.items-center.justify-between.mb-6
    %h1.text-3xl.font-bold.text-gray-900 Facturas de Proveedores
    
    = link_to new_web_invoice_path, class: "inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-700 hover:bg-slate-800 text-white text-sm font-semibold rounded-lg shadow-sm transition-colors" do
      %span +
      %span Nueva Factura

  -# Card de Filtros
  .bg-white.border.border-slate-200.rounded-lg.p-4.mb-6
    = form_with url: web_invoices_path, method: :get, data: { controller: "filter-form", turbo_frame: "invoices_content" }, class: "flex flex-col md:flex-row items-stretch md:items-center gap-4" do |f|
      
      -# B√∫squeda por n√∫mero de factura
      .flex-1
        = text_field_tag :invoice_search, params[:invoice_search], 
                         placeholder: "üîç Buscar por N¬∞ de factura (ej: 001)...", 
                         class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                         data: { action: "input->filter-form#submitWithDebounce" }
      
      -# Dropdown de proveedores
      .flex-1
        = select_tag :supplier_id, options_for_select([["üîç Filtrar por proveedor...", ""]] + @suppliers.map { |s| [s.name, s.id] }, @selected_supplier&.id), class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all", data: { action: "change->filter-form#submit" }
      
      -# Bot√≥n limpiar (visible solo si hay filtros activos)
      - if @selected_supplier || params[:invoice_search].present?
        .flex.items-center.gap-2
          = link_to web_invoices_path, class: "inline-flex items-center justify-center px-3 py-2 text-slate-600 text-sm font-medium hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors" do
            %span ‚úï
            %span Limpiar

  -# Turbo Frame para recargar solo el contenido (no el formulario)
  = turbo_frame_tag "invoices_content" do
    -# Metric Cards
    %div.grid.grid-cols-1.md:grid-cols-2.lg:grid-cols-3.gap-6.mb-6
      -# Card 1: Deuda Total Pendiente
      %div{ class: "bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md transition-all p-6" }
        .flex.items-start.justify-between.mb-4
          .flex-1
            %p.text-sm.font-medium.text-gray-600.mb-1 Deuda Total Pendiente
            %h3.text-3xl.font-bold.text-gray-900
              = currency_ar_int(@total_pending_amount)
          
          .w-12.h-12.bg-gray-100.rounded-xl.flex.items-center.justify-center.text-2xl
            üí∞
        
        .text-sm.text-gray-500
          %span.font-medium.text-gray-700
            = Invoice.simple_mode.pending_payment.for_supplier(@selected_supplier).search_invoice(params[:invoice_search]).count
          %span facturas pendientes

      -# Card 2: Cr√©dito a Favor
      %div{ class: "bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md transition-all p-6" }
        .flex.items-start.justify-between.mb-4
          .flex-1
            %p.text-sm.font-medium.text-gray-600.mb-1 Cr√©dito a Favor
            %h3.text-3xl.font-bold{ class: @total_credit_amount > 0 ? "text-green-600" : "text-gray-900" }
              = currency_ar_int(@total_credit_amount)
          
          .w-12.h-12{ class: @total_credit_amount > 0 ? "bg-green-100" : "bg-gray-100" }
            .rounded-xl.flex.items-center.justify-center.text-2xl.w-full.h-full
              ‚úÖ
        
        .text-sm{ class: @total_credit_amount > 0 ? "text-green-600" : "text-gray-500" }
          %span.font-medium{ class: @total_credit_amount > 0 ? "text-green-700" : "text-gray-700" }
            = @credit_notes_count
          %span notas de cr√©dito

      -# Card 3: Balance Neto
      %div{ class: "bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md transition-all p-6" }
        .flex.items-start.justify-between.mb-4
          .flex-1
            %p.text-sm.font-medium.text-gray-600.mb-1 Balance Neto
            %h3.text-3xl.font-bold{ class: @net_balance > 0 ? "text-blue-600" : "text-gray-900" }
              = currency_ar_int(@net_balance)
          
          .w-12.h-12.bg-blue-100.rounded-xl.flex.items-center.justify-center.text-2xl
            üìä
        
        .text-sm.text-gray-500
          %span Deuda - Cr√©dito

    -# Mostrar mensaje de √©xito si existe
    - if flash[:notice]
      .bg-green-50.border-l-4.border-green-500.p-4.rounded-lg.mb-6.flex.items-start.gap-3
        .w-10.h-10.rounded-xl.bg-green-500.flex.items-center.justify-center.text-white.flex-shrink-0
          ‚úì
        .flex-1
          %h4.font-semibold.text-green-800.mb-1 √âxito
          %p.text-sm.text-green-700= flash[:notice]

    -# Mostrar alerta si existe
    - if flash[:alert]
      .bg-red-50.border-l-4.border-red-500.p-4.rounded-lg.mb-6.flex.items-start.gap-3
        .w-10.h-10.rounded-xl.bg-red-500.flex.items-center.justify-center.text-white.flex-shrink-0
          ‚ö†Ô∏è
        .flex-1
          %h4.font-semibold.text-red-800.mb-1 Error
          %p.text-sm.text-red-700= flash[:alert]

    -# Lista de facturas
    - if @invoices.any?
      .bg-white.border.border-slate-200.rounded-lg.overflow-hidden
        %table.min-w-full.divide-y.divide-slate-200
          %thead.bg-slate-50
            %tr
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Fecha
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Proveedor
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                N¬∞ Factura
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Vencimiento
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Moneda
              %th.px-4.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Monto
              %th.px-4.py-3.text-center.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Estado
              %th.px-4.py-3.text-center.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Acciones
          
          %tbody.divide-y.divide-slate-100.bg-white
            - @invoices.each do |invoice|
              %tr.hover:bg-slate-50.transition-colors
                %td.px-4.py-3.whitespace-nowrap
                  %p.text-sm.text-slate-900= invoice.purchase_date.strftime("%d/%m/%Y")
                
                %td.px-4.py-3.whitespace-nowrap
                  %p.text-sm.font-medium.text-slate-900= invoice.supplier.name
                
                %td.px-4.py-3.whitespace-nowrap
                  %p.text-sm.font-mono.text-slate-700= invoice.invoice_number
                
                %td.px-4.py-3.whitespace-nowrap
                  - if invoice.due_date
                    %p.text-sm.text-slate-900= invoice.due_date.strftime("%d/%m/%Y")
                    - if invoice.overdue?
                      %p.text-xs.text-red-600.font-medium ¬°Vencida!
                    - elsif invoice.days_until_due && invoice.days_until_due <= 7 && invoice.days_until_due > 0
                      %p.text-xs.text-orange-600 Vence en #{invoice.days_until_due} d√≠as
                
                %td.px-4.py-3.whitespace-nowrap
                  %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium{ class: invoice.currency == 'USD' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800' }
                    = invoice.currency
                
                %td.px-4.py-3.whitespace-nowrap.text-right
                  %p.text-sm.font-bold.text-slate-900
                    = invoice.currency
                    = number_ar(invoice.amount)
                  - if invoice.currency == 'USD' && invoice.exchange_rate
                    %p.text-xs.text-slate-500
                      ‚âà ARS
                      = number_ar(invoice.total_amount_ars, precision: 0)
                
                %td.px-4.py-3.whitespace-nowrap.text-center
                  - if invoice.pending_status?
                    %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium.bg-yellow-100.text-yellow-800
                      Pendiente
                  - elsif invoice.paid_status?
                    %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium.bg-green-100.text-green-800
                      Pagada
                  - elsif invoice.cancelled_status?
                    %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium.bg-slate-100.text-slate-700
                      Cancelada
                
                %td.px-4.py-3.whitespace-nowrap.text-center
                  = link_to "Ver Detalle", web_invoice_path(invoice), class: "inline-flex items-center px-3 py-1.5 bg-slate-700 hover:bg-slate-800 text-white text-xs font-medium rounded-lg transition-colors", data: { turbo: false }

    - else
      .bg-white.border.border-slate-200.rounded-lg.p-16.text-center
        .inline-flex.w-20.h-20.rounded-full.bg-gray-100.items-center.justify-center.text-4xl.mb-4
          üìÑ
        %h3.text-xl.font-bold.text-gray-900.mb-2 No hay facturas registradas
        %p.text-gray-600.mb-6 Comenz√° registrando la primera factura de proveedor
        = link_to new_web_invoice_path, class: "inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-slate-700 hover:bg-slate-800 text-white text-sm font-semibold rounded-lg shadow-sm transition-colors" do
          %span +
          %span Nueva Factura

