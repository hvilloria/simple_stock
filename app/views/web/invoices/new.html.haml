- content_for :page_title, "Nueva Factura"

.container.mx-auto.px-6.py-6

  -# Header
  .flex.items-center.justify-between.mb-6
    = link_to web_invoices_path, class: "inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors" do
      %span ‚Üê
      %span Volver a Facturas
    
    %h1.text-3xl.font-bold.text-gray-900 Nueva Factura de Proveedor

  -# Errores
  - if flash[:alert]
    .bg-red-50.border-l-4.border-red-500.p-4.rounded-lg.mb-6.flex.items-start.gap-3
      .w-10.h-10.rounded-xl.bg-red-500.flex.items-center.justify-center.text-white.flex-shrink-0
        ‚ö†Ô∏è
      .flex-1
        %h4.font-semibold.text-red-800.mb-1 Error
        %p.text-sm.text-red-700= flash[:alert]

  = form_with url: web_invoices_path, method: :post, local: true, data: { controller: "invoice-form", action: "turbo:submit-start->invoice-form#handleFormSubmit" } do |f|
    
    .grid.grid-cols-1.lg:grid-cols-3.gap-6
      
      -# ============ COLUMNA IZQUIERDA (2/3) ============
      .lg:col-span-2.space-y-6

        -# CARD 1 - Informaci√≥n de la Factura
        .bg-white.border.border-slate-200.rounded-lg.p-6
          %h3.text-lg.font-semibold.text-gray-900.mb-4 Informaci√≥n de la Factura

          .space-y-4
            -# Proveedor
            %div
              .flex.items-center.justify-between.mb-2
                %label.block.text-sm.font-medium.text-gray-700 Proveedor
                %div{ data: { invoice_form_target: "paymentTermInfo" }, style: "display: none;" }
              
              = select_tag :supplier_id, 
                          options_for_select([["Seleccionar proveedor", "", { "data-payment-term-days": "0", "data-early-payment-days": "0", "data-early-payment-discount": "0" }]] + @suppliers.map { |s| [s.name, s.id, { "data-payment-term-days": s.payment_term_days || 0, "data-early-payment-days": s.early_payment_days || 0, "data-early-payment-discount": s.early_payment_discount_percentage || 0 }] }), 
                          class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all",
                          required: true,
                          data: { invoice_form_target: "supplier", action: "change->invoice-form#onSupplierChange" }
              
              %p.text-xs.text-gray-500.mt-1 Selecciona el proveedor que emiti√≥ la factura
            
            -# N√∫mero de Factura
            %div
              %label.block.text-sm.font-medium.text-gray-700.mb-2 N√∫mero de Factura
              = text_field_tag :invoice_number, nil,
                              placeholder: "Ej: FAC-001234",
                              class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all",
                              required: true
              %p.text-xs.text-gray-500.mt-1 N√∫mero de factura del proveedor
            
            -# Moneda (radio buttons visuales)
            %div
              %label.block.text-sm.font-medium.text-gray-700.mb-3 Moneda
              .grid.grid-cols-2.gap-4
                %label.relative.flex.items-center.gap-3.p-4.border-2.border-gray-200.rounded-xl.cursor-pointer.hover:border-gray-400.transition-all{ id: "currency_ars_label" }
                  = radio_button_tag :currency, 'ARS', true, id: "currency_ars", data: { action: "change->invoice-form#toggleExchangeRate" }
                  .flex-1
                    %p.font-medium.text-gray-900 üá¶üá∑ ARS
                    %p.text-xs.text-gray-500 Pesos argentinos
                
                %label.relative.flex.items-center.gap-3.p-4.border-2.border-gray-200.rounded-xl.cursor-pointer.hover:border-gray-400.transition-all{ id: "currency_usd_label" }
                  = radio_button_tag :currency, 'USD', false, id: "currency_usd", data: { action: "change->invoice-form#toggleExchangeRate" }
                  .flex-1
                    %p.font-medium.text-gray-900 üíµ USD
                    %p.text-xs.text-gray-500 D√≥lares estadounidenses
            
            -# Tipo de Cambio (solo si USD)
            %div{ id: "exchange_rate_field", data: { invoice_form_target: "exchangeRateField" }, style: "display: none;" }
              %label.block.text-sm.font-medium.text-gray-700.mb-2 Tipo de Cambio
              = text_field_tag :exchange_rate, nil,
                              placeholder: "Ej: 1.200,00",
                              class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all",
                              data: { invoice_form_target: "exchangeRateInput", action: "blur->invoice-form#formatAmount focus->invoice-form#unformatAmount" }
              %p.text-xs.text-gray-500.mt-1 Tipo de cambio USD ‚Üí ARS
            
            -# Monto de la Factura
            %div
              %label.block.text-sm.font-medium.text-gray-700.mb-2 Monto Total
              = text_field_tag :amount, nil, 
                              placeholder: "0,00", 
                              class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all text-lg font-semibold", 
                              required: true, 
                              data: { invoice_form_target: "amount", action: "blur->invoice-form#formatAmount focus->invoice-form#unformatAmount" }
              %p.text-xs.text-gray-500.mt-1 Monto total de la factura (formato: 1.500.000,50)
            
            -# Fecha de Factura
            %div
              %label.block.text-sm.font-medium.text-gray-700.mb-2 Fecha de Factura
              = date_field_tag :purchase_date, Date.today,
                              class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all",
                              required: true,
                              data: { invoice_form_target: "purchaseDate", action: "change->invoice-form#onPurchaseDateChange" }
            
            -# Fecha de Vencimiento
            %div
              %label.block.text-sm.font-medium.text-gray-700.mb-2 Fecha de Vencimiento Normal
              = date_field_tag :due_date, 30.days.from_now.to_date,
                              class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all",
                              required: true,
                              data: { invoice_form_target: "dueDate" }
              %p.text-xs.text-gray-500.mt-1 Fecha l√≠mite de pago sin descuento (se calcula autom√°ticamente)

        -# CARD 2 - Descuento por pronto pago (solo si el proveedor lo tiene configurado)
        .bg-emerald-50.border.border-emerald-200.rounded-lg.p-6{ data: { invoice_form_target: "earlyPaymentSection" }, style: "display: none;" }
          .flex.items-start.gap-3.mb-4
            .text-2xl ‚ö°
            .flex-1
              %h3.text-sm.font-semibold.text-emerald-900.mb-1
                Descuento por Pronto Pago Disponible
              %p.text-xs.text-emerald-700{ data: { invoice_form_target: "earlyPaymentInfo" } }
                Este proveedor ofrece descuento por pago anticipado

          .grid.grid-cols-1.md:grid-cols-2.gap-4
            %div
              %label.block.text-sm.font-medium.text-slate-700.mb-2
                Vencimiento con descuento
              = date_field_tag :early_payment_due_date, nil,
                              class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                              data: { invoice_form_target: "earlyPaymentDueDate" }
              %p.text-xs.text-slate-500.mt-1
                Fecha l√≠mite para pagar con descuento

            %div
              %label.block.text-sm.font-medium.text-slate-700.mb-2
                Porcentaje de descuento
              = text_field_tag :early_payment_discount_percentage, nil,
                              placeholder: "5",
                              class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                              data: { invoice_form_target: "earlyPaymentDiscount" }
              %p.text-xs.text-slate-500.mt-1 Porcentaje de descuento (sin el s√≠mbolo %)

        -# CARD 3 - Notas
        .bg-white.border.border-slate-200.rounded-lg.p-6
          %h3.text-lg.font-semibold.text-gray-900.mb-4 Notas Adicionales

          %div
            %label.block.text-sm.font-medium.text-gray-700.mb-2 Notas (Opcional)
            = text_area_tag :notes, nil,
                          rows: 3,
                          placeholder: "Informaci√≥n adicional sobre la factura...",
                          class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all resize-none"

      -# ============ COLUMNA DERECHA (1/3) ============
      .lg:col-span-1
        .bg-white.border.border-slate-200.rounded-lg.p-6.lg:sticky.lg:top-24
          %h3.text-lg.font-semibold.text-gray-900.mb-6 Resumen

          -# Info de modo simple
          .bg-blue-50.border.border-blue-200.rounded-lg.p-4.mb-4
            .flex.items-start.gap-3
              %span.text-2xl ‚ÑπÔ∏è
              .flex-1
                %p.text-sm.font-medium.text-blue-900 Modo Simple
                %p.text-xs.text-blue-700.mt-1 
                  Registramos solo la factura sin detalle de productos.
                  El stock NO se actualiza.

          .space-y-3.mb-6
            .flex.justify-between.text-sm
              %span.text-gray-600 Tipo de registro
              %span.font-medium.text-gray-900 Factura

            .flex.justify-between.text-sm
              %span.text-gray-600 Estado inicial
              %span
                %span.px-2.py-1.bg-yellow-100.text-yellow-700.text-xs.rounded-full.font-medium Pendiente de pago

          .border-t.border-gray-200.py-4
            %h4.text-sm.font-semibold.text-gray-900.mb-3 Qu√© NO hace este registro:
            
            .space-y-2
              .flex.items-start.gap-2.text-sm
                %span.text-red-500 ‚úó
                %span.text-gray-600 No actualiza stock de productos
              
              .flex.items-start.gap-2.text-sm
                %span.text-red-500 ‚úó
                %span.text-gray-600 No recalcula costos promedio

          .border-t.border-gray-200.pt-4
            = submit_tag "Registrar Factura", 
                        class: "w-full inline-flex items-center justify-center gap-2 px-4 py-3 bg-slate-700 hover:bg-slate-800 text-white text-base font-semibold rounded-lg shadow-sm transition-colors"

          .mt-4.text-center
            %p.text-xs.text-gray-500 La factura quedar√° pendiente de pago hasta que la marques como pagada
