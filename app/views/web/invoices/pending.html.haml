- content_for :page_title, "Pagos Pendientes"

.container.mx-auto.px-6.py-6
  
  -# Header
  .flex.items-center.justify-between.mb-6
    .flex-1
      %h1.text-3xl.font-bold.text-gray-900 ðŸ’¸ Pagos Pendientes
      %p.text-sm.text-gray-600.mt-1
        Facturas pendientes de pago agrupadas por proveedor
    
    .text-right
      %p.text-xs.text-gray-500 Ãšltima actualizaciÃ³n
      %p.text-sm.font-medium.text-gray-700= Time.current.strftime("%d/%m/%Y %H:%M")
  
  -# Filtro de perÃ­odo
  .bg-white.border.border-slate-200.rounded-lg.p-4.mb-6
    = form_with url: pending_web_invoices_path, method: :get, class: "flex items-center gap-4" do |f|
      
      %label.text-sm.font-medium.text-gray-700 Mostrar:
      
      = select_tag :period, options_for_select([["Esta Semana (#{Date.current.beginning_of_week.strftime('%d/%m')} - #{Date.current.end_of_week.strftime('%d/%m')})", "this_week"], ["PrÃ³xima Semana", "next_week"], ["Este Mes (#{Date.current.strftime('%B')})", "this_month"], ["PrÃ³ximo Mes", "next_month"], ["âš ï¸ Vencidas (atrasadas)", "overdue"]], @selected_period), class: "flex-1 px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 transition-all", onchange: "this.form.requestSubmit()"
  
  -# MÃ©tricas globales
  .grid.grid-cols-1.md:grid-cols-2.lg:grid-cols-3.gap-6.mb-6
    
    -# Total a pagar (neto)
    .bg-white.border.border-slate-200.rounded-lg.shadow-sm.hover:shadow-md.transition-all.p-6
      .flex.items-start.justify-between.mb-4
        .flex-1
          %p.text-sm.font-medium.text-gray-600.mb-1 Total a Transferir
          %h3.text-3xl.font-bold.text-blue-600
            = currency_ar_int(@total_to_pay)
        
        .w-12.h-12.bg-blue-100.rounded-xl.flex.items-center.justify-center.text-2xl
          ðŸ’¸
      
      .text-sm.text-gray-500
        %span.font-medium.text-gray-700
          = @suppliers_with_payments.count
        %span= @suppliers_with_payments.count == 1 ? "proveedor" : "proveedores"
    
    -# Facturas
    .bg-white.border.border-slate-200.rounded-lg.shadow-sm.hover:shadow-md.transition-all.p-6
      .flex.items-start.justify-between.mb-4
        .flex-1
          %p.text-sm.font-medium.text-gray-600.mb-1 Facturas Pendientes
          %h3.text-3xl.font-bold.text-gray-900
            = currency_ar_int(@total_invoices_amount)
        
        .w-12.h-12.bg-gray-100.rounded-xl.flex.items-center.justify-center.text-2xl
          ðŸ“„
      
      .text-sm.text-gray-500
        %span.font-medium.text-gray-700
          = @total_invoices_count
        %span= @total_invoices_count == 1 ? "factura" : "facturas"
    
    -# CrÃ©ditos
    .bg-white.border.border-slate-200.rounded-lg.shadow-sm.hover:shadow-md.transition-all.p-6
      .flex.items-start.justify-between.mb-4
        .flex-1
          %p.text-sm.font-medium.text-gray-600.mb-1 CrÃ©dito Disponible
          %h3.text-3xl.font-bold.text-green-600
            = "- #{currency_ar_int(@total_credits_amount)}"
        
        .w-12.h-12.bg-green-100.rounded-xl.flex.items-center.justify-center.text-2xl
          âœ…
      
      .text-sm.text-green-600
        %span.font-medium
          = @total_credits_count
        %span= @total_credits_count == 1 ? "nota de crÃ©dito" : "notas de crÃ©dito"
  
  -# Tabla agrupada por proveedor
  - if @suppliers_with_payments.any?
    .bg-white.border.border-slate-200.rounded-lg.overflow-hidden
      %table.min-w-full
        %thead.bg-slate-50
          %tr
            %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase
              Proveedor
            %th.px-4.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase
              Facturas
            %th.px-4.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase
              CrÃ©ditos
            %th.px-4.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase
              A Transferir
            %th.px-4.py-3.text-center.text-xs.font-medium.text-slate-500.uppercase
              Acciones
        
        %tbody.divide-y.divide-slate-100
          - @suppliers_with_payments.each do |data|
            -# Fila principal del proveedor
            %tr.hover:bg-slate-50.transition-colors
              %td.px-4.py-4
                %p.font-semibold.text-slate-900= data[:supplier].name
                %p.text-xs.text-gray-500
                  = data[:invoices_count]
                  = data[:invoices_count] == 1 ? "factura vence" : "facturas vencen"
              
              %td.px-4.py-4.text-right
                %p.font-medium.text-gray-900
                  = currency_ar_int(data[:invoices_amount])
                %p.text-xs.text-gray-500
                  = data[:invoices_count]
                  = data[:invoices_count] == 1 ? "factura" : "facturas"
              
              %td.px-4.py-4.text-right
                - if data[:credits_amount] > 0
                  %p.font-medium.text-green-600
                    = "- #{currency_ar_int(data[:credits_amount])}"
                - else
                  %p.text-gray-400 â€”
              
              %td.px-4.py-4.text-right
                %p.text-xl.font-bold.text-blue-600
                  = currency_ar_int(data[:amount_to_pay])
              
              %td.px-4.py-4.text-center
                %button{ type: "button", class: "inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white text-sm font-medium rounded-lg transition-colors cursor-pointer", onclick: "openPaymentModal(#{data[:supplier].id}, '#{data[:supplier].name}', #{data[:invoices_count]})" }
                  Marcar como Pagado
            
            -# Filas de detalle de facturas (opcional, expandible)
            - data[:invoices].each do |invoice|
              %tr.bg-slate-25.text-sm
                %td.px-4.py-2.pl-12
                  %span.text-gray-600.font-mono.text-xs= invoice.invoice_number
                %td.px-4.py-2.text-right.text-gray-600
                  = currency_ar_int(invoice.total_amount_ars)
                %td.px-4.py-2.text-right.text-gray-500.text-xs
                  = invoice.due_date.strftime("%d/%m/%Y")
                %td.px-4.py-2{colspan: 2}
  
  - else
    .bg-white.border.border-slate-200.rounded-lg.p-16.text-center
      .inline-flex.w-20.h-20.rounded-full.bg-green-100.items-center.justify-center.text-4xl.mb-4
        âœ“
      %h3.text-xl.font-bold.text-gray-900.mb-2 No hay pagos pendientes
      %p.text-gray-600
        No tienes facturas que venzan en el perÃ­odo seleccionado

-# Modal de confirmaciÃ³n de pago
#paymentModal{ style: "display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;", onclick: "closePaymentModal()" }
  .bg-white.rounded-lg.p-6{ style: "max-width: 32rem; width: 100%; margin: 0 1rem;", onclick: "event.stopPropagation()" }
    .flex.items-center.justify-between.mb-4
      %h3#modalTitle.text-lg.font-semibold.text-gray-900 Confirmar Pago
      %button.text-gray-400.hover:text-gray-600.cursor-pointer{ type: "button", onclick: "closePaymentModal()" }
        %span.text-2xl Ã—

    %p#modalMessage.text-sm.text-gray-600.mb-4

    %form#paymentForm{ method: "post", action: "#" }
      .mb-4
        %label.block.text-sm.font-medium.text-gray-700.mb-2 Fecha de Pago
        = date_field_tag :payment_date, Date.today,
                        class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-slate-700 focus:border-transparent transition-all",
                        required: true
        %p.text-xs.text-gray-500.mt-1 Fecha en que se realizÃ³ el pago

      .flex.items-center.gap-3
        %button.cursor-pointer.flex-1.px-4.py-2.border.border-slate-300.text-slate-700.font-semibold.rounded-lg.hover:bg-slate-50.transition-colors{ type: "button", onclick: "closePaymentModal()" }
          Cancelar
        
        %button.cursor-pointer.flex-1.px-4.py-2.bg-slate-700.hover:bg-slate-800.text-white.font-semibold.rounded-lg.transition-colors{ type: "submit" }
          Confirmar Pago

:javascript
  function openPaymentModal(supplierId, supplierName, invoicesCount) {
    const modal = document.getElementById('paymentModal');
    const form = document.getElementById('paymentForm');
    const title = document.getElementById('modalTitle');
    const message = document.getElementById('modalMessage');
    
    // Actualizar tÃ­tulo y mensaje
    title.textContent = `Marcar facturas de ${supplierName} como Pagadas`;
    message.textContent = `Â¿EstÃ¡s seguro de marcar ${invoicesCount} ${invoicesCount === 1 ? 'factura' : 'facturas'} de ${supplierName} como pagadas?`;
    
    // Actualizar action del form
    const period = '#{@selected_period}';
    form.action = `/web/invoices/mark_supplier_paid?supplier_id=${supplierId}&period=${period}`;
    
    // Mostrar modal con flex
    modal.style.display = 'flex';
  }
  
  function closePaymentModal() {
    const modal = document.getElementById('paymentModal');
    modal.style.display = 'none';
  }
