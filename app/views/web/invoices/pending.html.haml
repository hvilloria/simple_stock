- content_for :page_title, "Pagos Pendientes"

.container.mx-auto.px-6.py-6
  
  -# Header
  .flex.items-center.justify-between.mb-6
    .flex-1
      %h1.text-3xl.font-bold.text-gray-900 üí∏ Pagos Pendientes
      %p.text-sm.text-gray-600.mt-1
        Facturas pendientes de pago agrupadas por proveedor
    
    .text-right
      %p.text-xs.text-gray-500 √öltima actualizaci√≥n
      %p.text-sm.font-medium.text-gray-700= Time.current.strftime("%d/%m/%Y %H:%M")
  
  -# Filtro de per√≠odo
  .bg-white.border.border-slate-200.rounded-lg.p-4.mb-6
    = form_with url: pending_web_invoices_path, method: :get, class: "flex items-center gap-4" do |f|
      
      %label.text-sm.font-medium.text-gray-700 Mostrar:
      
      = select_tag :period, options_for_select([["Esta Semana (#{Date.current.beginning_of_week.strftime('%d/%m')} - #{Date.current.end_of_week.strftime('%d/%m')})", "this_week"], ["Pr√≥xima Semana", "next_week"], ["Este Mes (#{Date.current.strftime('%B')})", "this_month"], ["Pr√≥ximo Mes", "next_month"], ["‚ö†Ô∏è Vencidas (atrasadas)", "overdue"]], @selected_period), class: "flex-1 px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 transition-all", onchange: "this.form.requestSubmit()"
  
  -# Pagos Anticipados con Descuento
  - if @early_payment_invoices.any?
    .bg-gradient-to-r.from-emerald-50.to-green-50.border.border-emerald-200.rounded-lg.p-6.mb-6
      .flex.items-start.gap-4.mb-4
        .flex-1
          %h2.text-xl.font-bold.text-emerald-900.mb-2
            Pagos Anticipados
          %p.text-sm.text-emerald-700.mb-3
            Estas facturas vencen despu√©s de esta semana, pero el descuento expira ANTES del pr√≥ximo jueves de pago. Si las pag√°s esta semana, ahorr√°s
            = currency_ar_int(@early_payment_savings)
          
          .flex.items-center.gap-4.text-sm
            .flex.items-center.gap-2
              .w-2.h-2.bg-emerald-500.rounded-full
              %span.font-medium.text-emerald-900= @early_payment_count
              %span.text-emerald-700= @early_payment_count == 1 ? 'factura' : 'facturas'
            .flex.items-center.gap-2
              .w-2.h-2.bg-emerald-500.rounded-full
              %span.font-medium.text-emerald-900= currency_ar_int(@early_payment_amount)
              %span.text-emerald-700 monto total
      
      .bg-white.border.border-emerald-200.rounded-lg.overflow-hidden
        %table.min-w-full
          %thead.bg-emerald-50
            %tr
              %th.px-4.py-3.text-left.text-xs.font-medium.text-emerald-900.uppercase Proveedor
              %th.px-4.py-3.text-left.text-xs.font-medium.text-emerald-900.uppercase N¬∞ Factura
              %th.px-4.py-3.text-center.text-xs.font-medium.text-emerald-900.uppercase Vence Normal
              %th.px-4.py-3.text-center.text-xs.font-medium.text-emerald-900.uppercase Vence Desc.
              %th.px-4.py-3.text-center.text-xs.font-medium.text-emerald-900.uppercase Descuento
              %th.px-4.py-3.text-right.text-xs.font-medium.text-emerald-900.uppercase Monto
              %th.px-4.py-3.text-right.text-xs.font-medium.text-emerald-900.uppercase Con Desc.
              %th.px-4.py-3.text-center.text-xs.font-medium.text-emerald-900.uppercase Ahorro
              %th.px-4.py-3.text-center.text-xs.font-medium.text-emerald-900.uppercase Acci√≥n
          
          %tbody.divide-y.divide-emerald-100
            - @early_payment_invoices.each do |invoice|
              %tr.hover:bg-emerald-50.transition-colors
                %td.px-4.py-3
                  %p.font-medium.text-slate-900= invoice.supplier.name
                %td.px-4.py-3
                  %p.font-mono.text-sm.text-slate-700= invoice.invoice_number
                %td.px-4.py-3.text-center
                  %p.text-sm.text-slate-600= invoice.due_date.strftime("%d/%m/%Y")
                %td.px-4.py-3.text-center
                  %p.text-sm.font-medium.text-emerald-700= invoice.early_payment_due_date.strftime("%d/%m/%Y")
                  %p.text-xs.text-emerald-600= "Expira en #{invoice.days_until_discount_expires} d√≠as"
                %td.px-4.py-3.text-center
                  .inline-flex.items-center.gap-1.px-2.py-1.bg-emerald-100.text-emerald-800.rounded-md.text-xs.font-semibold
                    ‚ö°
                    = "#{invoice.early_payment_discount_percentage}%"
                %td.px-4.py-3.text-right
                  %p.text-sm.text-slate-600.line-through= currency_ar_int(invoice.total_amount_ars)
                %td.px-4.py-3.text-right
                  %p.text-lg.font-bold.text-emerald-700= currency_ar_int(invoice.amount_with_discount_ars)
                %td.px-4.py-3.text-center
                  %p.text-sm.font-semibold.text-emerald-600= "- #{currency_ar_int(invoice.potential_savings_ars)}"
                %td.px-4.py-3.text-center
                  %button{ type: "button", class: "inline-flex items-center px-3 py-1.5 bg-emerald-100 hover:bg-emerald-700  text-xs font-medium rounded-lg transition-colors cursor-pointer", onclick: "openSingleInvoicePaymentModal(#{invoice.id}, '#{invoice.invoice_number}', '#{invoice.supplier.name}', #{invoice.total_amount_ars.to_i}, true, #{invoice.early_payment_discount_percentage}, '#{invoice.early_payment_due_date.strftime("%d/%m")}', #{invoice.amount_with_discount_ars.to_i})" }
                    Pagar

  -# M√©tricas globales
  .grid.grid-cols-1.md:grid-cols-2.lg:grid-cols-3.gap-6.mb-6
    
    -# Total a pagar (neto)
    .bg-white.border.border-slate-200.rounded-lg.shadow-sm.hover:shadow-md.transition-all.p-6
      .flex.items-start.justify-between.mb-4
        .flex-1
          %p.text-sm.font-medium.text-gray-600.mb-1 Total a Transferir
          %h3.text-3xl.font-bold.text-blue-600
            = currency_ar_int(@total_to_pay)
        
        .w-12.h-12.bg-blue-100.rounded-xl.flex.items-center.justify-center.text-2xl
          üí∏
      
      .text-sm.text-gray-500
        %span.font-medium.text-gray-700
          = @suppliers_with_payments.count
        %span= @suppliers_with_payments.count == 1 ? "proveedor" : "proveedores"
    
    -# Facturas
    .bg-white.border.border-slate-200.rounded-lg.shadow-sm.hover:shadow-md.transition-all.p-6
      .flex.items-start.justify-between.mb-4
        .flex-1
          %p.text-sm.font-medium.text-gray-600.mb-1 Facturas Pendientes
          %h3.text-3xl.font-bold.text-gray-900
            = currency_ar_int(@total_invoices_amount)
        
        .w-12.h-12.bg-gray-100.rounded-xl.flex.items-center.justify-center.text-2xl
          üìÑ
      
      .text-sm.text-gray-500
        %span.font-medium.text-gray-700
          = @total_invoices_count
        %span= @total_invoices_count == 1 ? "factura" : "facturas"
    
    -# Cr√©ditos
    .bg-white.border.border-slate-200.rounded-lg.shadow-sm.hover:shadow-md.transition-all.p-6
      .flex.items-start.justify-between.mb-4
        .flex-1
          %p.text-sm.font-medium.text-gray-600.mb-1 Cr√©dito Disponible
          %h3.text-3xl.font-bold.text-green-600
            = "- #{currency_ar_int(@total_credits_amount)}"
        
        .w-12.h-12.bg-green-100.rounded-xl.flex.items-center.justify-center.text-2xl
          ‚úÖ
      
      .text-sm.text-green-600
        %span.font-medium
          = @total_credits_count
        %span= @total_credits_count == 1 ? "nota de cr√©dito" : "notas de cr√©dito"
  
  -# Pagos Regulares
  - if @suppliers_with_payments.any?
    %h2.text-xl.font-bold.text-slate-900.mb-4
      üìã Pagos Regulares (vencen esta semana)
    .bg-white.border.border-slate-200.rounded-lg.overflow-hidden
      %table.min-w-full
        %thead.bg-slate-50
          %tr
            %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase
              Proveedor
            %th.px-4.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase
              Facturas
            %th.px-4.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase
              Cr√©ditos
            %th.px-4.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase
              A Transferir
            %th.px-4.py-3.text-center.text-xs.font-medium.text-slate-500.uppercase
              Acciones
        
        %tbody.divide-y.divide-slate-100
          - @suppliers_with_payments.each do |data|
            -# Fila principal del proveedor
            %tr.hover:bg-slate-50.transition-colors
              %td.px-4.py-4
                %p.font-semibold.text-slate-900= data[:supplier].name
                %p.text-xs.text-gray-500
                  = data[:invoices_count]
                  = data[:invoices_count] == 1 ? "factura vence" : "facturas vencen"
              
              %td.px-4.py-4.text-right
                %p.font-medium.text-gray-900
                  = currency_ar_int(data[:invoices_amount])
                %p.text-xs.text-gray-500
                  = data[:invoices_count]
                  = data[:invoices_count] == 1 ? "factura" : "facturas"
              
              %td.px-4.py-4.text-right
                - if data[:credits_amount] > 0
                  %p.font-medium.text-green-600
                    = "- #{currency_ar_int(data[:credits_amount])}"
                - else
                  %p.text-gray-400 ‚Äî
              
              %td.px-4.py-4.text-right
                %p.text-xl.font-bold.text-blue-600
                  = currency_ar_int(data[:amount_to_pay])
              
              %td.px-4.py-4.text-center
                %button{ type: "button", class: "inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white text-sm font-medium rounded-lg transition-colors cursor-pointer", onclick: "openPaymentModal(#{data[:supplier].id}, '#{data[:supplier].name}', #{data[:invoices_count]})" }
                  Marcar como Pagado
            
            -# Filas de detalle de facturas (opcional, expandible)
            - data[:invoices].each do |invoice|
              %tr.bg-slate-25.text-sm
                %td.px-4.py-2.pl-12
                  %span.text-gray-600.font-mono.text-xs= invoice.invoice_number
                %td.px-4.py-2.text-right.text-gray-600
                  = currency_ar_int(invoice.total_amount_ars)
                %td.px-4.py-2.text-right.text-gray-500.text-xs
                  = invoice.due_date.strftime("%d/%m/%Y")
                %td.px-4.py-2{colspan: 2}
  
  -# Mensaje cuando no hay pagos (ni anticipados ni regulares)
  - if @suppliers_with_payments.empty? && @early_payment_invoices.empty?
    .bg-white.border.border-slate-200.rounded-lg.p-16.text-center
      .inline-flex.w-20.h-20.rounded-full.bg-green-100.items-center.justify-center.text-4xl.mb-4
        ‚úì
      %h3.text-xl.font-bold.text-gray-900.mb-2 No hay pagos pendientes
      %p.text-gray-600
        No tienes facturas que venzan en el per√≠odo seleccionado

-# Modal de confirmaci√≥n de pago
#paymentModal{ style: "display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;", onclick: "if(event.target === this) closePaymentModal()" }
  .bg-white.rounded-lg.p-6{ style: "max-width: 32rem; width: 100%; margin: 0 1rem;", onclick: "event.stopPropagation()" }
    .flex.items-center.justify-between.mb-4
      %h3#modalTitle.text-lg.font-semibold.text-gray-900 Marcar como pagada
      %button.text-gray-400.hover:text-gray-600.cursor-pointer{ type: "button", onclick: "closePaymentModal()" }
        %span.text-2xl √ó
    
    %form#paymentForm{ method: "post", action: "#" }
      -# Info del proveedor y monto (para caso de m√∫ltiples facturas)
      #supplierInfo.mb-4.p-3.bg-slate-50.rounded-lg
        %p#modalMessage.text-sm.text-slate-600

      -# Opci√≥n de descuento (si aplica - solo para facturas individuales)
      #discountSection{ style: "display: none;" }
        .mb-4.p-4.bg-emerald-50.border.border-emerald-200.rounded-lg
          .flex.items-start.gap-3.mb-3
            .text-2xl ‚ö°
            .flex-1
              %h4.text-sm.font-semibold.text-emerald-900.mb-1
                Descuento Disponible
              %p#discountInfo.text-xs.text-emerald-700
                Vence el XX/XX - X% de descuento
          
          .space-y-2
            %label.flex.items-center.gap-3.cursor-pointer.p-3.border-2.border-slate-200.rounded-lg.hover:bg-slate-50.transition-colors
              = radio_button_tag "apply_discount", "false", true, 
                                 class: "w-4 h-4 text-slate-700"
              .flex-1
                %span.text-sm.font-medium.text-slate-900
                  Pagar monto completo
                %p#fullAmountText.text-xs.text-slate-600
                  ARS XXX.XXX
            
            %label.flex.items-center.gap-3.cursor-pointer.p-3.border-2.border-emerald-500.bg-emerald-50.rounded-lg.hover:bg-emerald-100.transition-colors
              = radio_button_tag "apply_discount", "true", false,
                                 class: "w-4 h-4 text-emerald-600"
              .flex-1
                %span.text-sm.font-medium.text-emerald-900
                  Pagar con descuento ‚≠ê
                %p#discountAmountText.text-xs.text-emerald-700
                  ARS XXX.XXX (ahorr√°s ARS XXX)
      
      .mb-4
        %label.block.text-sm.font-medium.text-gray-700.mb-2
          Fecha de Pago
        = date_field_tag :payment_date, Date.current,
                        class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all",
                        required: true
      
      .flex.items-center.gap-3
        %button.cursor-pointer.flex-1.px-4.py-2.border.border-slate-300.text-slate-700.font-semibold.rounded-lg.hover:bg-slate-50.transition-colors{ type: "button", onclick: "closePaymentModal()" }
          Cancelar
        
        %button.cursor-pointer.flex-1.px-4.py-2.bg-slate-700.hover:bg-slate-800.text-white.font-semibold.rounded-lg.transition-colors{ type: "submit" }
          Confirmar Pago

:javascript
  let currentInvoice = null;
  
  // Para marcar proveedor completo
  function openPaymentModal(supplierId, supplierName, invoicesCount) {
    const modal = document.getElementById('paymentModal');
    const form = document.getElementById('paymentForm');
    const title = document.getElementById('modalTitle');
    const message = document.getElementById('modalMessage');
    const discountSection = document.getElementById('discountSection');
    
    currentInvoice = null;
    
    title.textContent = `Marcar facturas de ${supplierName} como Pagadas`;
    message.textContent = `¬øEst√°s seguro de marcar ${invoicesCount} ${invoicesCount === 1 ? 'factura' : 'facturas'} de ${supplierName} como pagadas?`;
    
    discountSection.style.display = 'none';
    
    const period = #{@selected_period.to_json};
    form.action = `/web/invoices/mark_supplier_paid?supplier_id=${supplierId}&period=${period}`;
    
    modal.style.display = 'flex';
  }
  
  // Para marcar factura individual con opci√≥n de descuento
  function openSingleInvoicePaymentModal(invoiceId, invoiceNumber, supplierName, amount, hasDiscount, discountPercentage, discountDueDate, amountWithDiscount) {
    currentInvoice = {
      id: invoiceId,
      number: invoiceNumber,
      supplier: supplierName,
      amount: amount,
      hasDiscount: hasDiscount,
      discountPercentage: discountPercentage,
      discountDueDate: discountDueDate,
      amountWithDiscount: amountWithDiscount
    };
    
    const modal = document.getElementById('paymentModal');
    const form = document.getElementById('paymentForm');
    const title = document.getElementById('modalTitle');
    const message = document.getElementById('modalMessage');
    const discountSection = document.getElementById('discountSection');
    
    title.textContent = `Marcar Factura ${invoiceNumber} como Pagada`;
    message.textContent = `Proveedor: ${supplierName} | Monto: ARS ${amount.toLocaleString('es-AR')}`;
    
    if (hasDiscount) {
      discountSection.style.display = 'block';
      document.getElementById('discountInfo').textContent = 
        `Vence el ${discountDueDate} - ${discountPercentage}% de descuento`;
      document.getElementById('fullAmountText').textContent = 
        `ARS ${amount.toLocaleString('es-AR')}`;
      document.getElementById('discountAmountText').textContent = 
        `ARS ${amountWithDiscount.toLocaleString('es-AR')} (ahorr√°s ARS ${(amount - amountWithDiscount).toLocaleString('es-AR')})`;
    } else {
      discountSection.style.display = 'none';
    }
    
    form.action = `/web/invoices/${invoiceId}/mark_as_paid`;
    modal.style.display = 'flex';
  }
  
  function closePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
    currentInvoice = null;
  }
