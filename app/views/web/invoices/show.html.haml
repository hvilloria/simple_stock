- content_for :page_title, "Factura #{@invoice.invoice_number}"

.container.mx-auto.px-6.py-6

  -# Header
  .flex.items-center.justify-between.mb-6
    .flex.items-center.gap-4
      = link_to web_invoices_path, class: "text-gray-600 hover:text-gray-900" do
        %span.text-xl ‚Üê
      %h1.text-3xl.font-bold.text-gray-900
        Factura
        = @invoice.invoice_number

    .flex.items-center.gap-3
      - if @invoice.pending_status?
        = link_to "Editar", edit_web_invoice_path(@invoice), class: "px-4 py-2 border border-slate-300 text-slate-700 font-semibold rounded-lg hover:bg-slate-50 transition-colors"
        
        %button.px-4.py-2.bg-green-600.hover:bg-green-700.text-white.font-semibold.rounded-lg.transition-colors{
          onclick: "document.getElementById('markAsPaidModal').classList.remove('hidden')"
        }
          ‚úì Marcar como Pagada

  -# Notices/Alerts
  - if flash[:notice]
    .bg-green-50.border-l-4.border-green-500.p-4.rounded-lg.mb-6
      %p.text-sm.text-green-700= flash[:notice]
  
  - if flash[:alert]
    .bg-red-50.border-l-4.border-red-500.p-4.rounded-lg.mb-6
      %p.text-sm.text-red-700= flash[:alert]

  .grid.grid-cols-1.lg:grid-cols-3.gap-6

    -# Columna Principal (2/3)
    .lg:col-span-2.space-y-6

      -# Card Informaci√≥n de Factura
      .bg-white.border.border-slate-200.rounded-lg.p-6
        %h3.text-lg.font-semibold.text-gray-900.mb-4 Informaci√≥n de la Factura

        .space-y-3
          .flex.items-start.gap-3
            %span.text-gray-500.w-40.flex-shrink-0 Proveedor:
            = link_to @invoice.supplier.name, web_supplier_path(@invoice.supplier), class: "font-medium text-blue-600 hover:text-blue-800 hover:underline"

          .flex.items-start.gap-3
            %span.text-gray-500.w-40.flex-shrink-0 N¬∞ Factura:
            %span.font-mono.font-semibold.text-gray-900= @invoice.invoice_number

          .flex.items-start.gap-3
            %span.text-gray-500.w-40.flex-shrink-0 Fecha de Factura:
            %span.text-gray-900= @invoice.purchase_date.strftime("%d/%m/%Y")

          .flex.items-start.gap-3
            %span.text-gray-500.w-40.flex-shrink-0 Fecha de Vencimiento:
            .flex-1
              %span.text-gray-900= @invoice.due_date.strftime("%d/%m/%Y")
              - if @invoice.pending_status?
                - if @invoice.overdue?
                  %span.ml-2.px-2.py-1.bg-red-100.text-red-700.text-xs.rounded-full.font-medium
                    Vencida hace #{@invoice.days_until_due.abs} d√≠as
                - elsif @invoice.days_until_due && @invoice.days_until_due <= 7
                  %span.ml-2.px-2.py-1.bg-yellow-100.text-yellow-700.text-xs.rounded-full.font-medium
                    Vence en #{@invoice.days_until_due} d√≠as
                - else
                  %span.ml-2.text-sm.text-gray-500
                    (en #{@invoice.days_until_due} d√≠as)

          .flex.items-start.gap-3
            %span.text-gray-500.w-40.flex-shrink-0 Moneda:
            %span.text-gray-900= @invoice.currency

          - if @invoice.currency == "USD" && @invoice.exchange_rate
            .flex.items-start.gap-3
              %span.text-gray-500.w-40.flex-shrink-0 Tipo de Cambio:
              %span.text-gray-900= number_with_precision(@invoice.exchange_rate, precision: 2, delimiter: ".", separator: ",")

          .flex.items-start.gap-3
            %span.text-gray-500.w-40.flex-shrink-0 Monto:
            %span.text-2xl.font-bold.text-gray-900
              = @invoice.currency
              = number_with_precision(@invoice.amount, precision: 2, delimiter: ".", separator: ",")

          - if @invoice.currency == "USD" && @invoice.exchange_rate
            .flex.items-start.gap-3
              %span.text-gray-500.w-40.flex-shrink-0 Equivalente ARS:
              %span.text-lg.font-semibold.text-gray-700
                ARS
                = number_with_precision(@invoice.total_amount_ars, precision: 2, delimiter: ".", separator: ",")

          .flex.items-start.gap-3
            %span.text-gray-500.w-40.flex-shrink-0 Estado:
            %span
              - if @invoice.pending_status?
                %span.px-3.py-1.bg-yellow-100.text-yellow-700.rounded-full.font-medium üü° Pendiente
              - elsif @invoice.paid_status?
                %span.px-3.py-1.bg-green-100.text-green-700.rounded-full.font-medium ‚úÖ Pagada
              - elsif @invoice.cancelled_status?
                %span.px-3.py-1.bg-red-100.text-red-700.rounded-full.font-medium ‚ùå Cancelada

          - if @invoice.paid_status? && @invoice.paid_at
            .flex.items-start.gap-3
              %span.text-gray-500.w-40.flex-shrink-0 Fecha de Pago:
              %span.text-gray-900= @invoice.paid_at.to_date.strftime("%d/%m/%Y")

      -# Card Notas (si existen)
      - if @invoice.notes.present?
        .bg-white.border.border-slate-200.rounded-lg.p-6
          %h3.text-lg.font-semibold.text-gray-900.mb-4 Notas

          %p.text-gray-700.whitespace-pre-wrap= @invoice.notes

      -# Card Informaci√≥n del Proveedor
      .bg-white.border.border-slate-200.rounded-lg.p-6
        .flex.items-center.justify-between.mb-4
          %h3.text-lg.font-semibold.text-gray-900 Informaci√≥n del Proveedor
          = link_to "Ver completo ‚Üí", web_supplier_path(@invoice.supplier), class: "text-sm text-blue-600 hover:text-blue-800"

        .space-y-2
          - if @invoice.supplier.payment_term_days
            .flex.items-center.gap-2.text-sm
              %span üìÖ
              %span.text-gray-600
                Plazo de pago:
                %strong= @invoice.supplier.payment_term_display

          - if @invoice.supplier.email.present?
            .flex.items-center.gap-2.text-sm
              %span üìß
              %span.text-gray-600= @invoice.supplier.email

          - if @invoice.supplier.phone.present?
            .flex.items-center.gap-2.text-sm
              %span üìû
              %span.text-gray-600= @invoice.supplier.phone

          - if @invoice.supplier.cuit.present?
            .flex.items-center.gap-2.text-sm
              %span üè¢
              %span.text-gray-600.font-mono= @invoice.supplier.cuit

          - if @invoice.supplier.bank_alias.present?
            .flex.items-center.gap-2.text-sm
              %span üè¶
              %span.text-gray-600.font-mono= @invoice.supplier.bank_alias

    -# Columna Lateral (1/3)
    .lg:col-span-1
      .bg-white.border.border-slate-200.rounded-lg.p-6.sticky.top-24
        %h3.text-lg.font-semibold.text-gray-900.mb-4 Acciones

        .space-y-3
          - if @invoice.pending_status?
            %button.w-full.px-4.py-3.bg-green-600.hover:bg-green-700.text-white.font-semibold.rounded-lg.transition-colors{
              onclick: "document.getElementById('markAsPaidModal').classList.remove('hidden')"
            }
              ‚úì Marcar como Pagada

            = link_to edit_web_invoice_path(@invoice), class: "block w-full px-4 py-3 border-2 border-slate-300 text-slate-700 font-semibold rounded-lg hover:bg-slate-50 transition-colors text-center" do
              ‚úèÔ∏è Editar Factura

            = button_to cancel_web_invoice_path(@invoice),
                       method: :patch,
                       data: { turbo_confirm: "¬øEst√°s seguro de cancelar esta factura?" },
                       class: "w-full px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors" do
              ‚úó Cancelar Factura

          - elsif @invoice.paid_status?
            .text-center.py-8
              %p.text-5xl.mb-3 ‚úÖ
              %p.text-gray-600.font-medium Factura Pagada
              %p.text-sm.text-gray-500.mt-1
                = @invoice.paid_at.to_date.strftime("%d/%m/%Y")

          - elsif @invoice.cancelled_status?
            .text-center.py-8
              %p.text-5xl.mb-3 ‚ùå
              %p.text-gray-600.font-medium Factura Cancelada

-# Modal: Marcar como Pagada (SOLO SI PENDING)
- if @invoice.pending_status?
  #markAsPaidModal.hidden.fixed.inset-0.bg-black.bg-opacity-50.z-50.flex.items-center.justify-center
    .bg-white.rounded-lg.p-6.max-w-md.w-full.mx-4{ onclick: "event.stopPropagation()" }
      .flex.items-center.justify-between.mb-4
        %h3.text-lg.font-semibold.text-gray-900 Marcar como Pagada
        %button.text-gray-400.hover:text-gray-600{ onclick: "document.getElementById('markAsPaidModal').classList.add('hidden')" }
          %span.text-2xl √ó

      = form_with url: mark_as_paid_web_invoice_path(@invoice), method: :post, local: true do |f|
        .mb-4
          %label.block.text-sm.font-medium.text-gray-700.mb-2 Fecha de Pago
          = date_field_tag :payment_date, Date.today,
                          class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all",
                          required: true
          %p.text-xs.text-gray-500.mt-1 Fecha en que se realiz√≥ el pago

        .flex.items-center.gap-3
          %button.flex-1.px-4.py-2.border.border-slate-300.text-slate-700.font-semibold.rounded-lg.hover:bg-slate-50.transition-colors{ type: "button", onclick: "document.getElementById('markAsPaidModal').classList.add('hidden')" }
            Cancelar
          
          = f.submit "Confirmar Pago", class: "flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors"
