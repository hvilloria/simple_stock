- content_for :page_title, "Notas de Crédito"

.container.mx-auto.px-6.py-6

  -# Header
  .flex.items-center.justify-between.mb-6
    %h1.text-3xl.font-bold.text-gray-900 Notas de Crédito
    
    - if policy(CreditNote).create?
      = link_to new_web_credit_note_path, class: "inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-700 hover:bg-slate-800 text-white text-sm font-medium rounded-lg shadow-sm transition-colors" do
        %span + Nueva Nota de Crédito

  -# Notices/Alerts
  - if flash[:notice]
    .bg-green-50.border-l-4.border-green-500.p-4.rounded-lg.mb-6
      %p.text-sm.text-green-700= flash[:notice]
  
  - if flash[:alert]
    .bg-red-50.border-l-4.border-red-500.p-4.rounded-lg.mb-6
      %p.text-sm.text-red-700= flash[:alert]

  -# Filtros
  .bg-white.border.border-slate-200.rounded-lg.p-6.mb-6
    = form_with url: web_credit_notes_path, method: :get, data: { controller: "filter-form", turbo_frame: "credit_notes_content" } do |f|
      .grid.grid-cols-1.md:grid-cols-3.gap-4
        
        .form-group
          = label_tag :supplier_id, "Proveedor", class: "block text-sm font-medium text-gray-700 mb-2"
          = select_tag :supplier_id,
                      options_from_collection_for_select(@suppliers, :id, :name, @selected_supplier&.id),
                      prompt: "Todos los proveedores",
                      class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                      data: { action: "change->filter-form#submit" }
        
        .form-group
          = label_tag :status, "Estado", class: "block text-sm font-medium text-gray-700 mb-2"
          = select_tag :status, options_for_select([["Todos los estados", ""], ["Disponibles", "pending"], ["Aplicadas", "applied"], ["Canceladas", "cancelled"]], @selected_status), class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 transition-all", data: { action: "change->filter-form#submit" }
        
        .form-group
          = label_tag :search, "Buscar por N° NC", class: "block text-sm font-medium text-gray-700 mb-2"
          = text_field_tag :search,
                          params[:search],
                          placeholder: "Número de nota...",
                          class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                          data: { action: "input->filter-form#submitWithDebounce" }

  = turbo_frame_tag "credit_notes_content" do
    
    -# Métricas
    .grid.grid-cols-1.md:grid-cols-1.gap-6.mb-6
      .bg-white.border.border-slate-200.rounded-lg.p-6
        .flex.items-center.justify-between
          .flex-1
            %p.text-xs.font-medium.text-slate-500.uppercase.tracking-wide.mb-2 Crédito Total
            %h3.text-3xl.font-bold.text-green-600= number_to_currency(@total_credit_amount, unit: "ARS ", separator: ",", delimiter: ".", precision: 2)
            %p.text-sm.text-slate-600.mt-1= "#{@credit_notes_count} #{@credit_notes_count == 1 ? 'nota' : 'notas'}"
          .w-10.h-10.bg-green-100.rounded-lg.flex.items-center.justify-center.text-xl
            ✓

    -# Lista de Notas de Crédito
    - if @credit_notes.any?
      .bg-white.border.border-slate-200.rounded-lg.overflow-hidden
        .overflow-x-auto
          %table.min-w-full.divide-y.divide-slate-200
            %thead.bg-slate-50
              %tr
                %th.px-6.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider Fecha
                %th.px-6.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider Proveedor
                %th.px-6.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider N° Nota
                %th.px-6.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider Factura Ref
                %th.px-6.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase.tracking-wider Monto
                %th.px-6.py-3.text-center.text-xs.font-medium.text-slate-500.uppercase.tracking-wider Estado
                %th.px-6.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase.tracking-wider Acciones
            
            %tbody.bg-white.divide-y.divide-slate-200
              - @credit_notes.each do |credit_note|
                %tr.hover:bg-slate-50.transition-colors
                  %td.px-6.py-4.whitespace-nowrap.text-sm.text-gray-900
                    = credit_note.issue_date.strftime("%d/%m/%Y")
                  
                  %td.px-6.py-4.whitespace-nowrap
                    = link_to credit_note.supplier.name, web_supplier_path(credit_note.supplier), class: "text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline", data: { turbo: false }
                  
                  %td.px-6.py-4.whitespace-nowrap
                    %span.font-mono.text-sm.font-semibold.text-gray-900= credit_note.credit_note_number
                  
                  %td.px-6.py-4.whitespace-nowrap.text-sm.text-gray-600
                    - if credit_note.invoice.present?
                      = link_to credit_note.invoice.invoice_number, web_invoice_path(credit_note.invoice), class: "font-mono text-blue-600 hover:text-blue-800 hover:underline", data: { turbo: false }
                    - else
                      %span.text-gray-400 Sin factura
                  
                  %td.px-6.py-4.whitespace-nowrap.text-right
                    %span.text-sm.font-semibold.text-green-600
                      = credit_note.currency
                      = number_with_precision(credit_note.amount, precision: 2, delimiter: ".", separator: ",")
                    - if credit_note.currency == "USD"
                      .text-xs.text-gray-500.mt-1
                        ARS
                        = number_with_precision(credit_note.total_amount_ars, precision: 2, delimiter: ".", separator: ",")
                  
                  %td.px-6.py-4.whitespace-nowrap.text-center
                    - if credit_note.pending_status?
                      %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium.bg-emerald-100.text-emerald-800
                        Disponible
                    - elsif credit_note.applied_status?
                      %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium.bg-slate-100.text-slate-700
                        Aplicada
                    - elsif credit_note.cancelled_status?
                      %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium.bg-red-100.text-red-800
                        Cancelada
                  
                  %td.px-6.py-4.whitespace-nowrap.text-right.text-sm.font-medium
                    .flex.items-center.justify-end.gap-2
                      = link_to "Ver", web_credit_note_path(credit_note), class: "text-slate-600 hover:text-slate-900", data: { turbo: false }
                      - if policy(credit_note).edit?
                        = link_to "Editar", edit_web_credit_note_path(credit_note), class: "text-blue-600 hover:text-blue-900", data: { turbo: false }

    - else
      .bg-white.border.border-slate-200.rounded-lg.p-12.text-center
        .text-6xl.mb-4 ✓
        %h3.text-xl.font-semibold.text-gray-900.mb-2 No hay notas de crédito
        %p.text-gray-600
          - if @selected_supplier
            No se encontraron notas de crédito para este proveedor
          - elsif params[:search].present?
            No se encontraron notas con ese número
          - else
            Aún no se han registrado notas de crédito
