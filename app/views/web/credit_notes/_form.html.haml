= form_with model: @credit_note, url: @credit_note.persisted? ? web_credit_note_path(@credit_note) : web_credit_notes_path, method: @credit_note.persisted? ? :patch : :post, data: { controller: "credit-note-form", action: "turbo:submit-start->credit-note-form#handleFormSubmit" } do |f|
  
  -# Errores de validación
  - if @credit_note.errors.any?
    .bg-red-50.border-l-4.border-red-500.p-4.rounded-lg.mb-6
      %h3.text-sm.font-medium.text-red-800.mb-2
        = "#{pluralize(@credit_note.errors.count, 'error')} impidió guardar esta nota de crédito:"
      %ul.list-disc.list-inside.text-sm.text-red-700
        - @credit_note.errors.full_messages.each do |message|
          %li= message

  .grid.grid-cols-1.lg:grid-cols-3.gap-6

    -# Columna principal del formulario
    .lg:col-span-2.space-y-6
      
      -# Información básica
      .bg-white.border.border-slate-200.rounded-lg.p-6
        %h3.text-lg.font-semibold.text-gray-900.mb-4 Información Básica

        .space-y-4
          
          -# Proveedor
          .form-group
            = f.label :supplier_id, "Proveedor", class: "block text-sm font-medium text-gray-700 mb-2"
            = f.select :supplier_id,
                      options_from_collection_for_select(@suppliers, :id, :name, @credit_note.supplier_id),
                      { prompt: "Seleccionar proveedor" },
                      class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                      required: true,
                      data: { action: "change->credit-note-form#onSupplierChange" }
          
          -# Factura asociada (opcional)
          .form-group
            = f.label :invoice_id, "Factura Relacionada (opcional)", class: "block text-sm font-medium text-gray-700 mb-2"
            = f.select :invoice_id,
                      @invoices.any? ? options_from_collection_for_select(@invoices, :id, :invoice_number, @credit_note.invoice_id) : [],
                      { prompt: "Sin factura asociada", include_blank: true },
                      class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                      data: { credit_note_form_target: "invoiceSelect", action: "change->credit-note-form#onInvoiceChange" }
            %p.text-xs.text-gray-500.mt-1 Si asocias una factura, la moneda y tipo de cambio se heredan automáticamente
          
          -# N° Nota de Crédito
          .form-group
            = f.label :credit_note_number, "N° Nota de Crédito", class: "block text-sm font-medium text-gray-700 mb-2"
            = f.text_field :credit_note_number,
                          class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all font-mono",
                          placeholder: "NC-001",
                          required: true
          
          -# Fecha de emisión
          .form-group
            = f.label :issue_date, "Fecha de Emisión", class: "block text-sm font-medium text-gray-700 mb-2"
            = f.date_field :issue_date,
                          class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                          required: true

      -# Información monetaria
      .bg-white.border.border-slate-200.rounded-lg.p-6
        %h3.text-lg.font-semibold.text-gray-900.mb-4 Información Monetaria

        .space-y-4
          
          -# Moneda
          .form-group
            = f.label :currency, "Moneda", class: "block text-sm font-medium text-gray-700 mb-2"
            .flex.gap-4
              .flex.items-center
                = f.radio_button :currency, "ARS", class: "w-4 h-4 text-slate-600 border-slate-300 focus:ring-slate-500", data: { action: "change->credit-note-form#onCurrencyChange", credit_note_form_target: "currencyRadio" }
                = f.label :currency_ars, "ARS (Pesos)", class: "ml-2 text-sm font-medium text-gray-700"
              .flex.items-center
                = f.radio_button :currency, "USD", class: "w-4 h-4 text-slate-600 border-slate-300 focus:ring-slate-500", data: { action: "change->credit-note-form#onCurrencyChange", credit_note_form_target: "currencyRadio" }
                = f.label :currency_usd, "USD (Dólares)", class: "ml-2 text-sm font-medium text-gray-700"
            - if @credit_note.invoice.present?
              %p.text-xs.text-amber-600.mt-1 La moneda está heredada de la factura asociada
          
          -# Tipo de cambio (solo si USD)
          .form-group{ data: { credit_note_form_target: "exchangeRateField" } }
            = f.label :exchange_rate, "Tipo de Cambio", class: "block text-sm font-medium text-gray-700 mb-2"
            = f.text_field :exchange_rate,
                          class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                          placeholder: "0,00",
                          data: { credit_note_form_target: "exchangeRateInput", action: "blur->credit-note-form#formatAmount focus->credit-note-form#unformatAmount" }
            %p.text-xs.text-gray-500.mt-1 Tipo de cambio USD → ARS (formato: 1.200,00)
          
          -# Monto
          .form-group
            = f.label :amount, "Monto", class: "block text-sm font-medium text-gray-700 mb-2"
            = f.text_field :amount,
                          value: @credit_note.amount ? number_with_precision(@credit_note.amount, precision: 2, delimiter: ".", separator: ",") : nil,
                          class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all text-lg font-semibold",
                          placeholder: "0,00",
                          required: true,
                          data: { credit_note_form_target: "amountInput", action: "blur->credit-note-form#formatAmount focus->credit-note-form#unformatAmount" }
            %p.text-xs.text-gray-500.mt-1 Monto de la nota de crédito (formato: 1.500.000,50)

        -# Notas
        .bg-white.border.border-slate-200.rounded-lg.p-6
          %h3.text-lg.font-semibold.text-gray-900.mb-4 Notas Adicionales

          = f.text_area :notes,
                        class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                        rows: 4,
                        placeholder: "Detalles adicionales sobre esta nota de crédito (opcional)..."

    -# Columna lateral con resumen
    .lg:col-span-1
      .bg-white.border.border-slate-200.rounded-lg.p-6.sticky.top-24
        %h3.text-lg.font-semibold.text-gray-900.mb-4 Acciones
        
        .space-y-3
          = f.submit @credit_note.persisted? ? "Actualizar Nota" : "Registrar Nota",
                    class: "w-full px-4 py-2.5 bg-slate-700 hover:bg-slate-800 text-white text-sm font-medium rounded-lg shadow-sm transition-colors"
          
          = link_to "Cancelar", @credit_note.persisted? ? web_credit_note_path(@credit_note) : web_credit_notes_path,
                    class: "block w-full px-4 py-2.5 border border-slate-300 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors text-center"
