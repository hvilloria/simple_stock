- content_for :page_title, "Facturas de Proveedores"

.container.mx-auto.px-6.py-6

  -# Header con navegaci√≥n
  .flex.items-center.justify-between.mb-6
    %h1.text-3xl.font-bold.text-gray-900 Facturas de Proveedores
    
    = link_to new_web_purchase_path, class: "inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-700 hover:bg-slate-800 text-white text-sm font-semibold rounded-lg shadow-sm transition-colors" do
      %span +
      %span Nueva Factura

  -# Card de Filtros
  .bg-white.border.border-slate-200.rounded-lg.p-4.mb-6
    = form_with url: web_purchases_path, method: :get, data: { controller: "filter-form", turbo_frame: "purchases_content" }, class: "flex flex-col md:flex-row items-stretch md:items-center gap-4" do |f|
      
      -# B√∫squeda por n√∫mero de factura
      .flex-1
        = text_field_tag :invoice_search, params[:invoice_search], 
                         placeholder: "üîç Buscar por N¬∞ de factura (ej: 001)...", 
                         class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all",
                         data: { action: "input->filter-form#submitWithDebounce" }
      
      -# Dropdown de proveedores
      .flex-1
        = select_tag :supplier_id, options_for_select([["üîç Filtrar por proveedor...", ""]] + @suppliers.map { |s| [s.name, s.id] }, @selected_supplier&.id), class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all", data: { action: "change->filter-form#submit" }
      
      -# Bot√≥n limpiar (visible solo si hay filtros activos)
      - if @selected_supplier || params[:invoice_search].present?
        .flex.items-center.gap-2
          = link_to web_purchases_path, class: "inline-flex items-center justify-center px-3 py-2 text-slate-600 text-sm font-medium hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors" do
            %span ‚úï
            %span Limpiar

  -# Turbo Frame para recargar solo el contenido (no el formulario)
  = turbo_frame_tag "purchases_content" do
    -# Metric Cards
    %div.grid.grid-cols-1.md:grid-cols-2.lg:grid-cols-2.gap-6.mb-6
      -# Card 1: Deuda Total Pendiente
      %div{ class: "bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md transition-all p-6" }
        .flex.items-start.justify-between.mb-4
          .flex-1
            %p.text-sm.font-medium.text-gray-600.mb-1 Deuda Total Pendiente
            %h3.text-3xl.font-bold.text-gray-900
              = currency_ar_int(@total_pending_amount)
          
          .w-12.h-12.bg-gray-100.rounded-xl.flex.items-center.justify-center.text-2xl
            üí∞
        
        .text-sm.text-gray-500
          %span.font-medium.text-gray-700
            = Purchase.simple_mode.pending_payment.count
          %span facturas pendientes        

      -# Card 3: Vencen Esta Semana
      %div{ class: "bg-white border border-slate-200 rounded-lg shadow-sm hover:shadow-md transition-all p-6" }
        .flex.items-start.justify-between.mb-4
          .flex-1
            %p.text-sm.font-medium.text-gray-600.mb-1 Vencen Esta Semana
            %h3.text-3xl.font-bold{ class: @due_this_week_purchases.any? ? "text-amber-600" : "text-gray-900" }
              = currency_ar_int(@due_this_week_purchases.sum { |p| p.total_amount_ars })
          
          .w-12.h-12{ class: @due_this_week_purchases.any? ? "bg-amber-100" : "bg-gray-100" }
            .rounded-xl.flex.items-center.justify-center.text-2xl.w-full.h-full
              üìÖ
        
        .text-sm.text-gray-500
          %span.font-medium{ class: @due_this_week_purchases.any? ? "text-amber-700" : "text-gray-700" }
            = @due_this_week_purchases.count
          %span facturas vencen esta semana

    -# Mostrar mensaje de √©xito si existe
    - if flash[:notice]
      .bg-green-50.border-l-4.border-green-500.p-4.rounded-lg.mb-6.flex.items-start.gap-3
        .w-10.h-10.rounded-xl.bg-green-500.flex.items-center.justify-center.text-white.flex-shrink-0
          ‚úì
        .flex-1
          %h4.font-semibold.text-green-800.mb-1 √âxito
          %p.text-sm.text-green-700= flash[:notice]

    -# Mostrar alerta si existe
    - if flash[:alert]
      .bg-red-50.border-l-4.border-red-500.p-4.rounded-lg.mb-6.flex.items-start.gap-3
        .w-10.h-10.rounded-xl.bg-red-500.flex.items-center.justify-center.text-white.flex-shrink-0
          ‚ö†Ô∏è
        .flex-1
          %h4.font-semibold.text-red-800.mb-1 Error
          %p.text-sm.text-red-700= flash[:alert]

    -# Lista de facturas
    - if @purchases.any?
      .bg-white.border.border-slate-200.rounded-lg.overflow-hidden
        %table.min-w-full.divide-y.divide-slate-200
          %thead.bg-slate-50
            %tr
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Fecha
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Proveedor
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                N¬∞ Factura
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Vencimiento
              %th.px-4.py-3.text-left.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Moneda
              %th.px-4.py-3.text-right.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Monto
              %th.px-4.py-3.text-center.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Estado
              %th.px-4.py-3.text-center.text-xs.font-medium.text-slate-500.uppercase.tracking-wider
                Acciones
          
          %tbody.divide-y.divide-slate-100.bg-white
            - @purchases.each do |purchase|
              %tr.hover:bg-slate-50.transition-colors
                %td.px-4.py-3.whitespace-nowrap
                  %p.text-sm.text-slate-900= purchase.purchase_date.strftime("%d/%m/%Y")
                
                %td.px-4.py-3.whitespace-nowrap
                  %p.text-sm.font-medium.text-slate-900= purchase.supplier.name
                
                %td.px-4.py-3.whitespace-nowrap
                  %p.text-sm.font-mono.text-slate-700= purchase.invoice_number
                
                %td.px-4.py-3.whitespace-nowrap
                  - if purchase.due_date
                    %p.text-sm.text-slate-900= purchase.due_date.strftime("%d/%m/%Y")
                    - if purchase.overdue?
                      %p.text-xs.text-red-600.font-medium ¬°Vencida!
                    - elsif purchase.days_until_due && purchase.days_until_due <= 7 && purchase.days_until_due > 0
                      %p.text-xs.text-orange-600 Vence en #{purchase.days_until_due} d√≠as
                
                %td.px-4.py-3.whitespace-nowrap
                  %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium{ class: purchase.currency == 'USD' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800' }
                    = purchase.currency
                
                %td.px-4.py-3.whitespace-nowrap.text-right
                  %p.text-sm.font-bold.text-slate-900
                    = purchase.currency
                    = number_ar(purchase.amount)
                  - if purchase.currency == 'USD' && purchase.exchange_rate
                    %p.text-xs.text-slate-500
                      ‚âà ARS
                      = number_ar(purchase.total_amount_ars, precision: 0)
                
                %td.px-4.py-3.whitespace-nowrap.text-center
                  - if purchase.pending_status?
                    %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium.bg-yellow-100.text-yellow-800
                      Pendiente
                  - elsif purchase.paid_status?
                    %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium.bg-green-100.text-green-800
                      Pagada
                  - elsif purchase.cancelled_status?
                    %span.inline-flex.items-center.px-2.5.py-1.rounded-md.text-xs.font-medium.bg-slate-100.text-slate-700
                      Cancelada
                
                %td.px-4.py-3.whitespace-nowrap.text-center
                  - if purchase.pending_status?
                    %button{ type: "button", class: "inline-flex items-center gap-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-700 text-white text-xs font-medium rounded-lg border border-green-300 transition-colors cursor-pointer", onclick: "openPaymentModal(#{purchase.id}, '#{purchase.invoice_number}')" }
                      %span Confirmar pago
                  - else
                    = link_to "Ver Detalle", web_purchase_path(purchase), class: "inline-flex items-center px-3 py-1.5 bg-slate-700 hover:bg-slate-800 text-white text-xs font-medium rounded-lg transition-colors"

    - else
      .bg-white.border.border-slate-200.rounded-lg.p-16.text-center
        .inline-flex.w-20.h-20.rounded-full.bg-gray-100.items-center.justify-center.text-4xl.mb-4
          üìÑ
        %h3.text-xl.font-bold.text-gray-900.mb-2 No hay facturas registradas
        %p.text-gray-600.mb-6 Comenz√° registrando la primera factura de proveedor
        = link_to new_web_purchase_path, class: "inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-slate-700 hover:bg-slate-800 text-white text-sm font-semibold rounded-lg shadow-sm transition-colors" do
          %span +
          %span Nueva Factura

-# Modal fuera del turbo frame y container - position fixed lo pone sobre toda la pantalla
#paymentModal{ style: "display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;", onclick: "closePaymentModal()" }
  .bg-white.rounded-lg.p-6{ style: "max-width: 28rem; width: 100%; margin: 0 1rem;", onclick: "event.stopPropagation()" }
    .flex.items-center.justify-between.mb-4
      %h3#modalTitle.text-lg.font-semibold.text-gray-900 Marcar como pagada
      %button.text-gray-400.hover:text-gray-600.cursor-pointer{ type: "button", onclick: "closePaymentModal()" }
        %span.text-2xl √ó

    %form#paymentForm{ method: "post", action: "#" }
      .mb-4
        %label.block.text-sm.font-medium.text-gray-700.mb-2 Fecha de Pago
        = date_field_tag :payment_date, Date.today,
                        class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-700 focus:border-transparent transition-all",
                        required: true
        %p.text-xs.text-gray-500.mt-1 Fecha en que se realiz√≥ el pago

      .flex.items-center.gap-3
        %button.cursor-pointer.flex-1.px-4.py-2.border.border-slate-300.text-slate-700.font-semibold.rounded-lg.hover:bg-slate-50.transition-colors{ type: "button", onclick: "closePaymentModal()" }
          Cancelar
        
        %button.cursor-pointer.flex-1.px-4.py-2.bg-slate-700.hover:bg-green-700.text-white.font-semibold.rounded-lg.transition-colors{ type: "submit" }
          Confirmar Pago

:javascript
  function openPaymentModal(purchaseId, invoiceNumber) {
    const modal = document.getElementById('paymentModal');
    const form = document.getElementById('paymentForm');
    const title = document.getElementById('modalTitle');
    
    // Actualizar t√≠tulo
    title.textContent = `Marcar Factura ${invoiceNumber} como Pagada`;
    
    // Actualizar action del form
    form.action = `/web/purchases/${purchaseId}/mark_as_paid`;
    
    // Mostrar modal con flex
    modal.style.display = 'flex';
  }
  
  function closePaymentModal() {
    const modal = document.getElementById('paymentModal');
    modal.style.display = 'none';
  }
