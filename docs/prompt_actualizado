# PROMPT DE CONTEXTO - Sistema de GestiÃ³n Gente del Sol

---

## ðŸ“‹ INSTRUCCIONES DE USO

**Copiar este prompt completo al iniciar una nueva conversaciÃ³n, junto con los siguientes archivos:**

1. `FLUJOS.md` - Reglas de negocio y flujos funcionales
2. `DEVELOPMENT_GUIDE.md` - Arquitectura y guÃ­a de desarrollo
3. `CODE_PATTERNS.md` - Patrones de cÃ³digo y ejemplos
4. `UI_DESIGN_SPEC.md` - EspecificaciÃ³n de diseÃ±o UI/UX
5. Archivos adicionales segÃºn necesidad (modelos, services, controllers, etc.)

---

## ðŸŽ¯ CONTEXTO DEL PROYECTO

Estoy desarrollando un **sistema de gestiÃ³n de inventario y ventas** para **Gente del Sol**, un negocio de venta de repuestos de autos Honda en Buenos Aires, Argentina, con 35+ aÃ±os de trayectoria.

### InformaciÃ³n del Negocio
- **Nombre:** Gente del Sol
- **UbicaciÃ³n:** Av. Warnes 620, CABA, Buenos Aires, Argentina
- **Especialidad:** Repuestos Honda originales (OEM) y alternativos (Aftermarket)
- **Tipo:** Un solo local fÃ­sico (no es cadena)
- **Usuario principal:** Alfredo (dueÃ±o/vendedor)

---

## ðŸ› ï¸ STACK TÃ‰CNICO

- **Backend:** Ruby on Rails 7+
- **Base de datos:** PostgreSQL
- **Frontend:** Hotwire (Turbo + Stimulus)
- **Vistas:** HAML (NO ERB)
- **Estilos:** TailwindCSS (tailwindcss-rails gem)
- **Arquitectura:** Service-Oriented (thin controllers, lÃ³gica en services)
- **Testing:** RSpec

---

## ðŸ“ ARQUITECTURA Y PRINCIPIOS

### Estructura de Carpetas
```
app/
  controllers/web/       # Namespace principal
  models/               # Active Record models
  services/             # Casos de uso (Sales, Purchasing, Inventory, Payments)
  views/web/            # Vistas HAML
  javascript/controllers/ # Stimulus controllers
```

### Principios Clave
1. **Service-Oriented:** LÃ³gica de negocio compleja en services, NO en controllers
2. **Result Pattern:** Todos los services devuelven `Result.new(success?: bool, record: obj, errors: array)`
3. **Stock por Movimientos:** NUNCA editar `current_stock` directamente, siempre via `StockMovement`
4. **Thin Controllers:** Controllers solo reciben params, llaman services, y responden
5. **Transacciones:** Operaciones complejas siempre dentro de `ActiveRecord::Base.transaction`

---

## ðŸ“Š MODELOS PRINCIPALES

### Productos e Inventario
- **Product:** SKU, nombre, precio, costo promedio ponderado, stock actual (cached), origen, tipo (OEM/aftermarket)
- **StockMovement:** Movimientos de stock con reference polimÃ³rfico (Order, Purchase, o manual)
- **StockLocation:** Ubicaciones fÃ­sicas de almacenamiento

### Ventas
- **Order:** Ventas (cash o credit), con status (confirmed/cancelled)
- **OrderItem:** Items de cada venta
- **Customer:** Clientes (mostrador genÃ©rico + clientes con cuenta corriente)

### Pagos
- **Payment:** Pagos globales (no matched a ventas especÃ­ficas)
- CÃ¡lculo de saldo: `SUM(ventas_credit) - SUM(payments)`

### Compras
- **Purchase:** Compras en USD o ARS con tipo de cambio
- **PurchaseItem:** Items de cada compra
- **Supplier:** Proveedores

---

## ðŸŽ¨ DISEÃ‘O Y UI/UX

### FilosofÃ­a de DiseÃ±o
- **Estilo:** Limpio, minimalista, profesional (inspirado en dashboards modernos)
- **Colores:** Predominantemente blanco/gris, con rojo corporativo (#DC3545) como acento principal
- **Sin gradientes en:** Botones grandes, cards de contenido, backgrounds extensos
- **Con gradientes solo en:** Ãconos pequeÃ±os decorativos (opcional)

### Paleta de Colores
- **Primary (Rojo):** #DC3545 - Botones principales, acciones, alertas
- **Success (Verde):** #10B981 - Estados positivos, confirmaciones
- **Warning (Amarillo):** #F59E0B - Alertas, stock bajo
- **Info (Azul):** #3B82F6 - InformaciÃ³n neutral
- **Grises:** gray-50 a gray-900 para interfaz base

### Componentes Clave
- **Metric Cards:** Fondo blanco, Ã­cono con fondo de color claro, sin gradientes en la card
- **Botones:** Primario rojo sÃ³lido, secundario outline, ghost para terciario
- **Badges:** Colores sÃ³lidos semÃ¡nticos (verde/amarillo/rojo)
- **Inputs:** Border gris, focus ring rojo, rounded-xl
- **Cards:** Fondo blanco, shadow-soft, hover:shadow-card

### Layout
- **Sidebar:** Fondo slate-900 (gris oscuro), fixed left
- **Header:** Blanco con border-b, sticky top
- **Main Content:** Fondo gray-50

---

## ðŸ”‘ REGLAS DE NEGOCIO CRÃTICAS

### 1. Stock Management
- âŒ **NUNCA:** `product.update(current_stock: X)`
- âœ… **SIEMPRE:** Usar `Inventory::AdjustStock` service
- Stock = suma de todos los `StockMovement`
- Campo `current_stock` es cacheado, actualizado automÃ¡ticamente via callbacks

### 2. Costos de Productos
- `cost_unit` = **costo promedio ponderado** de TODAS las compras confirmadas
- Se recalcula automÃ¡ticamente al confirmar/anular compras via `recalculate_average_cost!`
- âŒ NO editar manualmente desde controllers/vistas
- Todas las compras se convierten a USD para uniformidad en el cÃ¡lculo

### 3. Tipos de Venta
- **Cash (contado):** No genera saldo, no crea Payment
- **Credit (cuenta corriente):** Genera saldo, requiere cliente con `has_credit_account: true`

### 4. Clientes
- **Cliente Mostrador:** GenÃ©rico, para todas las ventas de contado
- **Clientes registrados:** Con/sin cuenta corriente, para ventas a crÃ©dito

### 5. Saldo de Cliente
```ruby
saldo = SUM(orders.credit.not_cancelled.total_amount) - SUM(payments.amount)
```
- Los pagos NO se matchean a ventas especÃ­ficas (modelo global de saldo)

### 6. Productos OEM vs Aftermarket
- **OEM:** Repuestos originales de la marca del vehÃ­culo
- **Aftermarket:** Repuestos compatibles de otras marcas
- Cada variante (origen diferente) = SKU distinto
- Clientes preguntan por origen: JapÃ³n (premium), Taiwan, China, USA, etc.

### 7. AnulaciÃ³n de Ventas
- Status = `cancelled`
- Genera `StockMovement` inversos (devuelve stock)
- El saldo se recalcula automÃ¡ticamente (ventas canceladas no cuentan)
- NO hay devoluciones parciales en V1

---

## ðŸ“ CONVENCIONES DE CÃ“DIGO

### Idioma
- **CÃ³digo (clases, mÃ©todos, variables):** InglÃ©s
- **Comentarios:** InglÃ©s
- **Tests:** InglÃ©s
- **Commits:** InglÃ©s
- **Textos visibles al usuario:** EspaÃ±ol (voseo neutral argentino)

### Nomenclatura
```ruby
# âœ… BIEN
class Sales::CreateOrder
  def validate_stock_availability
    # ...
  end
end

# âŒ MAL
class Ventas::CrearOrden
  def validar_disponibilidad_stock
    # ...
  end
end
```

### Services Pattern
```ruby
module Sales
  class CreateOrder
    # MÃ©todo de clase
    def self.call(customer:, items:, order_type:, channel: nil)
      new(customer:, items:, order_type:, channel:).call
    end
    
    def initialize(customer:, items:, order_type:, channel: nil)
      @customer = customer
      @items = items
      @order_type = order_type
      @channel = channel
    end
    
    def call
      validate_params
      
      ActiveRecord::Base.transaction do
        create_order
        create_order_items
        create_stock_movements
        
        Result.new(success?: true, record: @order, errors: [])
      end
    rescue ValidationError => e
      Result.new(success?: false, record: nil, errors: [e.message])
    rescue StandardError => e
      Rails.logger.error("Error in #{self.class}: #{e.message}")
      Result.new(success?: false, record: nil, errors: ["Error creating order"])
    end
    
    private
    
    class ValidationError < StandardError; end
    
    def validate_params
      # Validaciones...
      raise ValidationError, "mensaje" if condicion_invalida
    end
  end
end
```

### Controllers Pattern
```ruby
class OrdersController < ApplicationController
  def create
    result = Sales::CreateOrder.call(
      customer: find_customer,
      items: parse_items,
      order_type: params[:order_type],
      channel: params[:channel]
    )
    
    if result.success?
      redirect_to result.record, notice: "Venta creada exitosamente"
    else
      flash.now[:alert] = result.errors.join(", ")
      render :new, status: :unprocessable_entity
    end
  end
end
```

---

## ðŸŽ¯ ESTADO ACTUAL DEL PROYECTO

### âœ… Backend Implementado
- Modelos principales (Product, Order, Customer, Payment, Purchase, StockMovement)
- Services principales (Sales::CreateOrder, Sales::CancelOrder, Inventory::AdjustStock)
- Validaciones y lÃ³gica de negocio
- Reference polimÃ³rfico para trazabilidad
- CÃ¡lculo de costo promedio ponderado
- CÃ¡lculo de saldo de clientes

### ðŸš§ En Desarrollo
- Vistas/Frontend (HAML + TailwindCSS)
- Controllers completos
- Stimulus controllers para interactividad
- Dashboard con mÃ©tricas

### âŒ NO Implementado (Futuro)
- AutenticaciÃ³n de usuarios (Devise)
- Manejo de chasis/VIN de vehÃ­culos
- IntegraciÃ³n con Mercado Libre
- Courier/flete en costos
- Matching de pagos a ventas especÃ­ficas
- Notas de crÃ©dito detalladas
- Devoluciones parciales

---

## ðŸ“‚ ARCHIVOS CLAVE DEL PROYECTO

### Modelos
- `app/models/product.rb` - Productos con validaciones, scopes, mÃ©todos de costo/margen
- `app/models/order.rb` - Ventas con enums, validaciones, asociaciones
- `app/models/customer.rb` - Clientes con mÃ©todo de cÃ¡lculo de saldo
- `app/models/stock_movement.rb` - Movimientos con reference polimÃ³rfico

### Services
- `app/services/sales/create_order.rb` - Crear venta con validaciÃ³n de stock
- `app/services/sales/cancel_order.rb` - Anular venta y reversar stock
- `app/services/inventory/adjust_stock.rb` - Crear movimientos de stock
- `app/services/purchasing/create_purchase.rb` - Crear compra y actualizar costos

### ConfiguraciÃ³n
- `config/routes.rb` - Rutas del sistema (namespace :web)
- `config/tailwind.config.js` - ConfiguraciÃ³n de Tailwind con paleta custom
- `app/assets/stylesheets/application.tailwind.css` - Clases helper y gradientes

---

## ðŸŽ¬ TAREAS TÃPICAS

### Crear una nueva vista
1. Leer `UI_DESIGN_SPEC.md` para diseÃ±o
2. Crear controller action (thin)
3. Crear vista HAML en `app/views/web/`
4. Usar componentes definidos en UI_DESIGN_SPEC
5. Aplicar TailwindCSS segÃºn paleta establecida

### Crear un nuevo service
1. Leer `CODE_PATTERNS.md` para estructura
2. Crear en `app/services/[dominio]/[accion].rb`
3. MÃ©todo de clase `.call`
4. Validar params
5. Usar transacciÃ³n si afecta mÃºltiples modelos
6. Devolver `Result`
7. Agregar tests en `spec/services/`

### Modificar lÃ³gica de negocio
1. Revisar `FLUJOS.md` para entender flujo actual
2. Modificar en model o service (NO en controller)
3. Actualizar tests
4. Ajustar controller/vista si es necesario

---

## âš ï¸ ANTI-PATRONES A EVITAR

âŒ **NO hacer:**
- Editar `current_stock` directamente
- Editar `cost_unit` manualmente (usar `recalculate_average_cost!`)
- Poner lÃ³gica de negocio en controllers
- Poner lÃ³gica de negocio en vistas
- Crear `StockMovement` fuera de `Inventory::AdjustStock`
- Olvidar validar stock antes de ventas
- Olvidar transacciones en operaciones multi-modelo
- Usar gradientes en botones/cards grandes
- Usar colores que no estÃ©n en la paleta definida

âœ… **SÃ hacer:**
- Usar services para operaciones complejas
- Controllers delgados
- Validar antes de ejecutar
- Usar transacciones
- Devolver `Result` desde services
- Stock SIEMPRE vÃ­a `Inventory::AdjustStock`
- Recalcular costo promedio al confirmar/anular compras
- Seguir `UI_DESIGN_SPEC.md` para diseÃ±o
- Usar HAML (no ERB)
- CÃ³digo en inglÃ©s, UI en espaÃ±ol

---

## ðŸ’¬ CÃ“MO PEDIRME AYUDA

### Para vistas/UI:
```
@UI_DESIGN_SPEC.md
Crear [vista de X] siguiendo el diseÃ±o minimalista con:
- Cards blancas
- Botones primarios rojos
- Badges con colores semÃ¡nticos
[Describir funcionalidad especÃ­fica]
```

### Para lÃ³gica de negocio:
```
@FLUJOS.md @CODE_PATTERNS.md
Necesito [acciÃ³n especÃ­fica, ej: implementar anulaciÃ³n de compra]
[Describir contexto y duda especÃ­fica]
```

### Para cÃ³digo backend:
```
@DEVELOPMENT_GUIDE.md @CODE_PATTERNS.md
Crear service para [acciÃ³n] que:
- [Requisito 1]
- [Requisito 2]
Siguiendo el patrÃ³n Result
```

---

## ðŸŽ¯ PRÃ“XIMOS PASOS SUGERIDOS

1. **Completar vistas principales:**
   - Dashboard con mÃ©tricas
   - Listado de productos con bÃºsqueda/filtros
   - Formulario de nueva venta
   - Listado de ventas
   - Detalle de cliente con saldo

2. **Implementar interactividad:**
   - BÃºsqueda de productos con autocomplete
   - Formulario dinÃ¡mico de venta (agregar/quitar items)
   - Modales de confirmaciÃ³n
   - Flash messages con Turbo

3. **Refinar UI:**
   - Responsive design
   - Estados de loading
   - Empty states
   - Validaciones en tiempo real

4. **Testing:**
   - Tests de services crÃ­ticos
   - Tests de modelos con lÃ³gica importante
   - System tests de flujos principales

---

## ðŸ“š DOCUMENTACIÃ“N DE REFERENCIA

**Leer SIEMPRE antes de generar cÃ³digo:**
1. `FLUJOS.md` - Para entender reglas de negocio
2. `DEVELOPMENT_GUIDE.md` - Para arquitectura y convenciones
3. `CODE_PATTERNS.md` - Para ejemplos de cÃ³digo y patrones
4. `UI_DESIGN_SPEC.md` - Para diseÃ±o de interfaces

**Archivos del proyecto a consultar segÃºn necesidad:**
- `app/models/` - Para ver estructura de modelos
- `app/services/` - Para ver services existentes
- `config/routes.rb` - Para ver rutas disponibles
- `db/schema.rb` - Para ver estructura de DB

---

## âœ¨ FILOSOFÃA DEL PROYECTO

Este sistema debe ser:
- **Simple y prÃ¡ctico:** Para uso diario de Alfredo
- **Confiable:** Sin perder datos, con trazabilidad completa
- **RÃ¡pido:** Respuestas inmediatas, sin fricciÃ³n
- **Visual:** Interfaz clara y agradable
- **Mantenible:** CÃ³digo limpio, testeado, documentado

El objetivo es que Alfredo pueda gestionar su negocio de forma eficiente, sin complicaciones tÃ©cnicas, con una interfaz moderna y profesional.

---

## ðŸ¤ TIPS PARA COLABORAR EFECTIVAMENTE

1. **Siempre adjuntar archivos .md relevantes** al iniciar la conversaciÃ³n
2. **Ser especÃ­fico** en lo que necesito (vista, service, correcciÃ³n, etc.)
3. **Mencionar el archivo** que necesito modificar o crear
4. **Revisar** que el cÃ³digo generado siga los patrones establecidos
5. **Pedir confirmaciÃ³n** antes de cambios grandes en arquitectura
6. **Consultar** si algo no estÃ¡ claro en la documentaciÃ³n


---
 ## pregunta cualquier cosa que necesites, ya sea sobre el codigo, el negocio, el diseÃ±o, etc.tambien te puedo compartir archivos del proyecto paraque tengas mas contexto.